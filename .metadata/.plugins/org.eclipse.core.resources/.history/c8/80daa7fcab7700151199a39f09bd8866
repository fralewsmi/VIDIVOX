package pkgBackgroundTasks;

import java.io.File;
import java.io.IOException;

import javax.swing.SwingWorker;

import pgkGUI.InputText;
import pgkGUI.MediaPlayer;
import pkgBashProcesses.ProcessSaveText;
import pkgBashProcesses.ProcessText2Wave;

public class MergeTTS  extends SwingWorker<Void, Void> {

	String outputLocation = ".out1.mp4";
	String textInput = InputText.getTextInput();

	@Override // Multiple process builders with festival, text2wave and ffmpeg
	protected Void doInBackground() throws Exception {
		try {
			File file = new File(".text.txt");
			file.delete();
			ProcessSaveText saveText = new ProcessSaveText();
			saveText.execute();
			
			file = new File(".wave.wav");
			file.delete();
			ProcessText2Wave txt2wav = new ProcessText2Wave();
			txt2wav.execute();
			
			String cmd = "ffmpeg -y -i .wave.wav -codec:a libmp3lame -qscale:a 2 .convert.mp3";
			ProcessBuilder builderConvert = new ProcessBuilder("/bin/bash", "-c", cmd);
			try {
				Process process = builderConvert.start();
				process.waitFor();
			} catch (IOException | InterruptedException e1) {
				e1.printStackTrace();
			}
			cmd = "ffmpeg -y -i " + MediaPlayer.getVideoLocation() + " -i .convert.mp3 -filter_complex amix=inputs=2 "
					+ outputLocation;
			ProcessBuilder builderAdd = new ProcessBuilder("/bin/bash", "-c", cmd);
			try {
				Process process = builderAdd.start();
				process.waitFor();
			} catch (IOException | InterruptedException e1) {
				e1.printStackTrace();
			}
		} catch (Exception e) {
			e.printStackTrace();
		}
		return null;
	}
	
	// Play the new video once the process is done
	protected void done() {

		MediaPlayer.getMediaPlayerComponent().getMediaPlayer().playMedia(outputLocation);
	}

}